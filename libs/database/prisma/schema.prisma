// libs/database/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  password     String
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  avatar       String?
  role         Role      @default(USER)
  isActive     Boolean   @default(true) @map("is_active")
  refreshToken String?   @map("refresh_token") @db.Text
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  profile           UserProfile?
  ownedProjects     Project[]              @relation("ProjectOwner")
  projectMembers    ProjectMember[]
  assignedTasks     TaskAssignee[]
  createdTasks      Task[]                 @relation("TaskCreator")
  comments          Comment[]
  activities        Activity[]
  notifications     Notification[]
  sentInvitations   ProjectInvitation[]    @relation("InvitationSender")
  notificationPrefs NotificationPreference?
  watchedTasks      TaskWatcher[]

  @@index([email])
  @@index([role])
  @@map("users")
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

model UserProfile {
  id          String @id @default(uuid())
  userId      String @unique @map("user_id")
  bio         String? @db.Text
  timezone    String @default("UTC")
  language    String @default("en")
  theme       String @default("light")
  preferences Json?  @db.JsonB

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id          String     @id @default(uuid())
  name        String
  key         String     @unique
  description String?    @db.Text
  ownerId     String     @map("owner_id")
  icon        String?
  color       String?    @default("#3B82F6")
  isArchived  Boolean    @default(false) @map("is_archived")
  visibility  Visibility @default(PRIVATE)
  settings    Json?      @db.JsonB
  archivedAt  DateTime?  @map("archived_at")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  owner       User                  @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     ProjectMember[]
  boards      Board[]
  labels      Label[]
  invitations ProjectInvitation[]

  @@index([ownerId])
  @@index([isArchived])
  @@index([key])
  @@map("projects")
}

enum Visibility {
  PRIVATE
  PUBLIC
  TEAM
}

model ProjectMember {
  id        String      @id @default(uuid())
  projectId String      @map("project_id")
  userId    String      @map("user_id")
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime    @default(now()) @map("joined_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model ProjectInvitation {
  id        String           @id @default(uuid())
  projectId String           @map("project_id")
  email     String
  role      ProjectRole      @default(MEMBER)
  invitedBy String           @map("invited_by")
  status    InvitationStatus @default(PENDING)
  token     String           @unique
  expiresAt DateTime         @map("expires_at")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inviter User    @relation("InvitationSender", fields: [invitedBy], references: [id])

  @@index([projectId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("project_invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

// ============================================
// BOARDS & COLUMNS
// ============================================

model Board {
  id        String    @id @default(uuid())
  projectId String    @map("project_id")
  name      String
  position  Int
  type      BoardType @default(KANBAN)
  settings  Json?     @db.JsonB
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  columns Column[]

  @@index([projectId])
  @@index([position])
  @@map("boards")
}

enum BoardType {
  KANBAN
  LIST
  CALENDAR
  TIMELINE
}

model Column {
  id          String   @id @default(uuid())
  boardId     String   @map("board_id")
  name        String
  position    Int
  color       String?  @default("#64748B")
  limit       Int?
  isCollapsed Boolean  @default(false) @map("is_collapsed")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  board Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([boardId])
  @@index([position])
  @@map("columns")
}

// ============================================
// TASKS
// ============================================

model Task {
  id             String     @id @default(uuid())
  key            String     @unique
  title          String
  description    String?    @db.Text
  columnId       String     @map("column_id")
  position       Int
  priority       Priority   @default(MEDIUM)
  status         TaskStatus @default(TODO)
  points         Int?
  dueDate        DateTime?  @map("due_date")
  startDate      DateTime?  @map("start_date")
  completedAt    DateTime?  @map("completed_at")
  estimatedHours Float?     @map("estimated_hours")
  actualHours    Float?     @map("actual_hours")
  creatorId      String     @map("creator_id")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Relations
  column       Column           @relation(fields: [columnId], references: [id], onDelete: Cascade)
  creator      User             @relation("TaskCreator", fields: [creatorId], references: [id])
  assignees    TaskAssignee[]
  labels       TaskLabel[]
  attachments  Attachment[]
  subtasks     Subtask[]
  comments     Comment[]
  dependencies TaskDependency[] @relation("DependentTask")
  dependents   TaskDependency[] @relation("DependsOnTask")
  watchers     TaskWatcher[]

  @@index([columnId])
  @@index([creatorId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([key])
  @@map("tasks")
}

enum Priority {
  LOWEST
  LOW
  MEDIUM
  HIGH
  HIGHEST
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  DONE
  CANCELLED
}

model TaskAssignee {
  id         String   @id @default(uuid())
  taskId     String   @map("task_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy String?  @map("assigned_by")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_assignees")
}

model TaskWatcher {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  watchedAt DateTime @default(now()) @map("watched_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_watchers")
}

model TaskDependency {
  id              String         @id @default(uuid())
  taskId          String         @map("task_id")
  dependsOnTaskId String         @map("depends_on_task_id")
  type            DependencyType @default(BLOCKS)
  createdAt       DateTime       @default(now()) @map("created_at")

  task          Task @relation("DependentTask", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOnTask Task @relation("DependsOnTask", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnTaskId])
  @@index([taskId])
  @@index([dependsOnTaskId])
  @@map("task_dependencies")
}

enum DependencyType {
  BLOCKS
  IS_BLOCKED_BY
  RELATES_TO
}

// ============================================
// LABELS
// ============================================

model Label {
  id          String   @id @default(uuid())
  name        String
  color       String   @default("#64748B")
  description String?
  projectId   String   @map("project_id")
  createdAt   DateTime @default(now()) @map("created_at")

  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   TaskLabel[]

  @@unique([projectId, name])
  @@index([projectId])
  @@map("labels")
}

model TaskLabel {
  id      String @id @default(uuid())
  taskId  String @map("task_id")
  labelId String @map("label_id")

  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([taskId, labelId])
  @@index([taskId])
  @@index([labelId])
  @@map("task_labels")
}

// ============================================
// SUBTASKS
// ============================================

model Subtask {
  id          String    @id @default(uuid())
  taskId      String    @map("task_id")
  title       String
  description String?   @db.Text
  completed   Boolean   @default(false)
  position    Int
  completedAt DateTime? @map("completed_at")
  completedBy String?   @map("completed_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([completed])
  @@map("subtasks")
}

// ============================================
// ATTACHMENTS
// ============================================

model Attachment {
  id         String   @id @default(uuid())
  taskId     String   @map("task_id")
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  thumbnail  String?
  uploadedBy String   @map("uploaded_by")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([uploadedBy])
  @@map("attachments")
}

// ============================================
// COMMENTS
// ============================================

model Comment {
  id        String   @id @default(uuid())
  content   String   @db.Text
  taskId    String   @map("task_id")
  authorId  String   @map("author_id")
  parentId  String?  @map("parent_id")
  mentions  String[]
  isEdited  Boolean  @default(false) @map("is_edited")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  task    Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author  User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([taskId])
  @@index([authorId])
  @@index([parentId])
  @@map("comments")
}

// ============================================
// ACTIVITY LOG
// ============================================

model Activity {
  id         String     @id @default(uuid())
  userId     String     @map("user_id")
  entityType EntityType @map("entity_type")
  entityId   String     @map("entity_id")
  action     ActionType
  changes    Json?      @db.JsonB
  metadata   Json?      @db.JsonB
  ipAddress  String?    @map("ip_address")
  userAgent  String?    @map("user_agent")
  createdAt  DateTime   @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@map("activities")
}

enum EntityType {
  USER
  PROJECT
  BOARD
  COLUMN
  TASK
  SUBTASK
  COMMENT
  LABEL
  ATTACHMENT
}

enum ActionType {
  CREATED
  UPDATED
  DELETED
  ARCHIVED
  RESTORED
  ASSIGNED
  UNASSIGNED
  COMMENTED
  MENTIONED
  MOVED
  STATUS_CHANGED
  PRIORITY_CHANGED
  DUE_DATE_CHANGED
  LABEL_ADDED
  LABEL_REMOVED
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  MEMBER_ADDED
  MEMBER_REMOVED
  COMPLETED
  REOPENED
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id         String           @id @default(uuid())
  userId     String           @map("user_id")
  type       NotificationType
  title      String
  message    String           @db.Text
  entityType String?          @map("entity_type")
  entityId   String?          @map("entity_id")
  actionUrl  String?          @map("action_url")
  isRead     Boolean          @default(false) @map("is_read")
  readAt     DateTime?        @map("read_at")
  data       Json?            @db.JsonB
  createdAt  DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_UPDATED
  TASK_COMMENTED
  TASK_DUE_SOON
  TASK_OVERDUE
  TASK_COMPLETED
  TASK_MENTIONED
  TASK_STATUS_CHANGED
  COMMENT_REPLY
  MENTION
  PROJECT_INVITED
  PROJECT_MEMBER_ADDED
  PROJECT_MEMBER_REMOVED
  PROJECT_UPDATED
  DAILY_SUMMARY
  WEEKLY_SUMMARY
}

model NotificationPreference {
  id              String  @id @default(uuid())
  userId          String  @unique @map("user_id")
  emailEnabled    Boolean @default(true) @map("email_enabled")
  pushEnabled     Boolean @default(true) @map("push_enabled")
  taskAssigned    Boolean @default(true) @map("task_assigned")
  taskUpdated     Boolean @default(false) @map("task_updated")
  taskCommented   Boolean @default(true) @map("task_commented")
  taskDueSoon     Boolean @default(true) @map("task_due_soon")
  taskOverdue     Boolean @default(true) @map("task_overdue")
  mentions        Boolean @default(true)
  projectInvite   Boolean @default(true) @map("project_invite")
  projectUpdates  Boolean @default(false) @map("project_updates")
  dailySummary    Boolean @default(false) @map("daily_summary")
  weeklySummary   Boolean @default(true) @map("weekly_summary")
  emailDigestTime String  @default("09:00") @map("email_digest_time")
  timezone        String  @default("UTC")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}